<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TransitMaster AI - Puebla</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { 
            width: 100%; height: 100%; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: #f4f7f9; overflow: hidden; 
        }
        #chat-app { display: flex; flex-direction: column; height: 100vh; width: 100%; }
        .header { 
            background: #1E88E5; color: white; padding: 15px; 
            font-weight: bold; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 15px; max-width: 85%; font-size: 15px; line-height: 1.4; }
        .user { align-self: flex-end; background: #1E88E5; color: white; border-bottom-right-radius: 2px; }
        .bot { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .img-box { background: #e3f2fd; padding: 10px; border-radius: 12px; border: 1px solid #1E88E5; margin-top: 8px; width: 100%; }
        .img-box img { width: 100%; border-radius: 8px; display: block; }
        .input-bar { padding: 12px; background: white; display: flex; gap: 10px; border-top: 1px solid #eee; }
        input { flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid #ddd; outline: none; }
        button { background: #1E88E5; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

    <div id="chat-app">
        <div class="header"><i class="fas fa-robot"></i> TransitMaster AI | Puebla</div>
        <div id="chat-container">
            <div class="msg bot">Â¡Hola Carlos! Soy tu asistente. PregÃºntame por la Ruta 19, Azteca, Loma o el RÃ¡pido.</div>
        </div>
        <div class="input-bar">
            <input type="text" id="user-input" placeholder="Ej: EnsÃ©Ã±ame la ruta Azteca" autocomplete="off">
            <button onclick="enviarMensaje()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
 // 1. CONFIGURACIÃ“N FIREBASE (MantÃ©n tus llaves aquÃ­)
const firebaseConfig = {
    apiKey: "AIzaSyD9BM3GgPH0Fpta5AOv0gzpTZ0RJDepE-k", // Tu API Key
    authDomain: "movitransporte-puebla.firebaseapp.com",
    databaseURL: "https://movitransporte-puebla-default-rtdb.firebaseio.com", // Â¡ESTA ES LA MÃS IMPORTANTE!
    projectId: "movitransporte-puebla",
    storageBucket: "movitransporte-puebla.firebasestorage.app",
    messagingSenderId: "1026517136643",
    appId: "1:1026517136643:web:595273b5f87b2a5228a536"
};
if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.database();

// 2. FUNCIÃ“N PARA ENVIAR FEEDBACK
function enviarFeedback() {
    const nombre = document.getElementById('fb-nombre').value;
    const comentario = document.getElementById('fb-comentario').value;
    if (!nombre || !comentario) return alert("Llena ambos campos");

    db.ref('observaciones').push({
        usuario: nombre,
        observacion: comentario,
        fecha: new Date().toLocaleString()
    }).then(() => {
        alert("Â¡Sugerencia enviada a Carlos!");
        document.getElementById('fb-nombre').value = "";
        document.getElementById('fb-comentario').value = "";
    });
}

// 3. FUNCIÃ“N PRINCIPAL DE LA IA
async function enviarMensaje() {
    const input = document.getElementById("user-input");
    const container = document.getElementById("chat-container");
    const texto = input.value.trim();
    if (!texto) return;

    const idTemp = "msg-" + Date.now();
    container.innerHTML += `<div class="msg user"><p>${texto}</p></div>`;
    container.innerHTML += `<div class="msg bot" id="${idTemp}"><p><i>TransitMaster pensando...</i></p></div>`;
    input.value = "";
    container.scrollTop = container.scrollHeight;

    try {
        // 1. FILTRO DE FIREBASE
        const snap = await db.ref('rutas').get();
        const rutas = snap.val() || {};
        let datosRuta = "";
        let nombreRutaDetectada = "";

        for (let r in rutas) {
            if (texto.toLowerCase().includes(r.toLowerCase())) {
                datosRuta = JSON.stringify(rutas[r]);
                nombreRutaDetectada = r;
                break;
            }
        }

        // 2. LLAMADA A LA IA (USANDO LLAMA-3.1-8B PARA AHORRAR TOKENS)
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { 
                "Authorization": "Bearer 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", 
                "Content-Type": "application/json" 
            },
            body: JSON.stringify({
                "model": "llama-3.1-8b-instant",
                "messages": [
                    { "role": "system", "content": `Eres TransitMaster Puebla. INSTRUCCIÃ“N: Si el usuario pregunta por una ruta y tienes estos datos: ${datosRuta}, explica el recorrido de forma amable. NO menciones nombres de archivos .jpg o .png. Si no hay datos, di que estÃ¡s mapeando.` },
                    { "role": "user", "content": texto }
                ]
            })
        });

        const data = await response.json();
        const respuestaIA = data.choices[0].message.content;
        document.getElementById(idTemp).innerHTML = `<p>${respuestaIA}</p>`;

        // 3. MOSTRAR IMAGEN (Si la ruta existe en tu catÃ¡logo)
        const catalogoFotos = {
            "68b": "ruta68b.jpg",
            "19": "ruta19.jpg",
            "61a": "ruta61a.jpg",
            "1a": "ruta1a.jpg",
            "RAzteca": "rutaazteca.jpg"
        };

        if (nombreRutaDetectada && catalogoFotos[nombreRutaDetectada.toLowerCase()]) {
            const fotoUrl = catalogoFotos[nombreRutaDetectada.toLowerCase()];
            container.innerHTML += `
                <div class="msg bot img-box">
                    <p style="font-size:12px; color:#1E88E5;"><b>Unidad Confirmada:</b></p>
                    <img src="${fotoUrl}" style="width:100%; border-radius:10px; margin-top:5px;" 
                         onerror="this.parentElement.style.display='none'">
                </div>`;
        }

    } catch (e) {
        document.getElementById(idTemp).innerHTML = "<p>Error de conexiÃ³n. Reintenta.</p>";
    }
    container.scrollTop = container.scrollHeight;
}

// Escuchar el Enter
document.getElementById('user-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') enviarMensaje();
});
    </script>
    <div style="padding: 20px; background: #e3f2fd; border-top: 2px solid #1e88e5; margin-top: 20px;">
    <h4 style="color: #1e88e5; margin-bottom: 10px;">ðŸš€ AyÃºdanos a mejorar TransitMaster</h4>
    <input type="text" id="fb-nombre" placeholder="Tu nombre" style="width: 100%; padding: 10px; margin-bottom: 5px;">
    <textarea id="fb-comentario" placeholder="Â¿QuÃ© rutas faltan? Danos tus ideas..." style="width: 100%; padding: 10px; height: 60px;"></textarea>
    <button onclick="enviarFeedback()" style="width: 100%; background: #1e88e5; color: white; border: none; padding: 10px; font-weight: bold; cursor: pointer;">Enviar a Carlos</button>
</div>

</body>
</html>
