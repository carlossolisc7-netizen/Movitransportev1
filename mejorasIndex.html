<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TransitMaster Pro - Sistema Avanzado de Transporte</title>
    
    <!-- Librer√≠as externas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ========== RESET Y BASE ========== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body, html {
            width: 100%; height: 100%; font-family: 'Roboto', sans-serif;
            overflow: hidden; touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        #map { width: 100%; height: 100%; background: #f0f0f0; }
        
        /* ========== ANIMACIONES BASE ========== */
        @keyframes busFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-3px) rotate(2deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(30, 136, 229, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(30, 136, 229, 0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        /* ========== BARRA SUPERIOR ========== */
        #top-bar-container {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 500px; z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #top-bar-container.collapsed { top: -200px; }
        
        #top-bar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-radius: 16px; padding: 12px;
            display: flex; flex-direction: column; gap: 8px;
        }
        
        #info-bar {
            display: flex; justify-content: space-between;
            align-items: center; font-size: 12px;
        }
        
        #weather-info, #time-info {
            display: flex; align-items: center; gap: 4px;
            padding: 6px 10px; border-radius: 20px;
            background: rgba(0, 0, 0, 0.05);
        }
        
        #main-controls { display: flex; flex-direction: column; gap: 8px; }
        
        .input-container { position: relative; display: flex; align-items: center; }
        .input-container i { position: absolute; left: 12px; color: #666; font-size: 16px; }
        
        #main-controls input {
            padding: 12px 12px 12px 40px; border-radius: 10px;
            border: 1px solid #e0e0e0; font-size: 14px;
            background: #f9f9f9; width: 100%; transition: all 0.2s;
        }
        
        #main-controls input:focus {
            outline: none; border-color: #1E88E5;
            background: white; box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }
        
        #action-buttons { display: flex; gap: 8px; }
        
        #action-buttons button {
            flex: 1; padding: 12px; border: none; border-radius: 10px;
            font-weight: 500; font-size: 14px; cursor: pointer;
            transition: all 0.2s; display: flex;
            align-items: center; justify-content: center; gap: 6px;
        }
        
        #btn-go { background-color: #1E88E5; color: white; }
        #btn-go:hover { background-color: #1565C0; }
        #btn-clear { background-color: #f5f5f5; color: #666; }
        #btn-clear:hover { background-color: #e0e0e0; }
        
        #toggle-panel-btn {
            position: absolute; bottom: -18px; left: 50%;
            transform: translateX(-50%); width: 36px; height: 18px;
            background-color: #1E88E5; border: none;
            border-radius: 0 0 12px 12px; cursor: pointer;
            z-index: 1001; display: flex; align-items: center;
            justify-content: center; color: white; font-size: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* ========== TABS FLOTANTES ========== */
        .floating-tabs {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 10px;
            z-index: 1000; padding: 0 15px; width: 100%;
            max-width: 500px; justify-content: center;
        }
        
        .tab-button {
            width: 44px; height: 44px; border-radius: 50%;
            border: none; background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 18px; cursor: pointer; color: #333;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        
        .tab-button.active {
            background-color: #1E88E5; color: white;
        }
        
        /* ========== PANELES FLOTANTES ========== */
        .floating-panel {
            position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%); width: 90%; max-width: 450px;
            max-height: 70vh; background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 16px; border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1002; display: none; flex-direction: column;
            overflow: hidden;
        }
        
        .floating-panel.active { display: flex; }
        
        .panel-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 12px;
            padding-bottom: 8px; border-bottom: 1px solid #eee;
        }
        
        .panel-header h3 {
            margin: 0; font-size: 18px;
            font-weight: 600; color: #333;
        }
        
        .close-btn {
            font-size: 22px; font-weight: bold;
            cursor: pointer; color: #666; padding: 4px;
        }
        
        .panel-content {
            flex: 1; overflow-y: auto; padding-right: 4px;
        }
        
        /* ========== CHAT IA ========== */
        #ia-chat {
            flex: 1; overflow-y: auto; margin-bottom: 12px;
            display: flex; flex-direction: column; gap: 8px;
            padding-right: 8px;
        }
        
        .message {
            padding: 10px 12px; border-radius: 12px;
            font-size: 14px; line-height: 1.4; max-width: 85%;
        }
        
        .user-message {
            align-self: flex-end; background-color: #1E88E5;
            color: white; border-bottom-right-radius: 4px;
        }
        
        .ia-message {
            align-self: flex-start; background-color: #f1f1f1;
            color: #333; border-bottom-left-radius: 4px;
        }
        
        #ia-form { display: flex; gap: 8px; margin-top: 8px; }
        
        #ia-form input {
            flex: 1; padding: 10px 12px; border-radius: 12px;
            border: 1px solid #ddd; font-size: 14px;
        }
        
        #ia-form button {
            padding: 10px 14px; background-color: #1E88E5;
            color: white; border: none; border-radius: 12px; cursor: pointer;
        }
        
        /* ========== ITEMS DE RUTA ========== */
        .route-item {
            display: flex; align-items: center; padding: 10px 0;
            border-bottom: 1px solid #f0f0f0; cursor: pointer;
        }
        
        .route-color {
            width: 16px; height: 16px; border-radius: 4px; margin-right: 12px;
        }
        
        .route-info { flex: 1; }
        
        .route-name {
            font-weight: 500; font-size: 15px; margin-bottom: 2px;
        }
        
        .route-stops { font-size: 13px; color: #666; }
        
        /* ========== PASOS DE RUTA ========== */
        .step {
            display: flex; gap: 12px; padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .step-icon {
            width: 24px; height: 24px; border-radius: 50%;
            background-color: #1E88E5; color: white;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; font-size: 12px;
        }
        
        .walk-icon { background-color: #4CAF50; }
        .bus-icon { background-color: #FF9800; }
        
        .step-content { flex: 1; }
        .step-title { font-weight: 500; font-size: 15px; margin-bottom: 4px; }
        .step-details { font-size: 13px; color: #666; }
        .step-distance { font-size: 12px; color: #999; margin-top: 4px; }
        
        /* ========== FORMULARIOS ========== */
        .form-group { margin-bottom: 12px; }
        .form-group label {
            display: block; font-size: 14px;
            margin-bottom: 6px; color: #555;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px 12px; border-radius: 8px;
            border: 1px solid #ddd; font-size: 14px;
        }
        
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        .form-actions { display: flex; gap: 8px; margin-top: 16px; }
        
        .form-actions button {
            flex: 1; padding: 10px; border: none;
            border-radius: 8px; font-weight: 500; cursor: pointer;
        }
        
        .btn-primary { background-color: #1E88E5; color: white; }
        .btn-secondary { background-color: #f5f5f5; color: #666; }
        
        /* ========== MARCADORES ========== */
        .user-marker {
            background-color: #1E88E5; border: 2px solid white;
            border-radius: 50%; width: 16px; height: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .bus-marker {
            background-color: #FF5722; border: 2px solid white;
            border-radius: 50%; width: 18px; height: 18px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 10px; font-weight: bold;
        }
        
        .stop-marker {
            background-color: #4CAF50; border: 2px solid white;
            border-radius: 50%; width: 12px; height: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .alert-marker {
            background-color: #F44336; border: 2px solid white;
            border-radius: 50%; width: 16px; height: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 10px; font-weight: bold;
        }
        
        /* ========== SIDEBAR ALERTAS ========== */
        .sidebar {
            position: fixed; top: 50%; right: -300px;
            transform: translateY(-50%); width: 260px; max-height: 80vh;
            padding: 16px; background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: 12px 0 0 12px;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000; transition: right 0.3s ease; overflow-y: auto;
        }
        
        .sidebar.active { right: 0; }
        
        .sidebar-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 12px;
            padding-bottom: 8px; border-bottom: 1px solid #eee;
        }
        
        .sidebar-title { font-size: 16px; font-weight: 600; color: #333; }
        .sidebar-close { font-size: 20px; cursor: pointer; color: #666; }
        
        .alert-item { padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .alert-title { font-weight: 500; font-size: 14px; margin-bottom: 4px; }
        .alert-details { font-size: 13px; color: #666; }
        .alert-time { font-size: 12px; color: #999; margin-top: 4px; }
        
        /* ========== SIMULACI√ìN ========== */
        #simulation-controls {
            position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%); width: 90%; max-width: 450px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 12px 16px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            z-index: 1001; display: none; flex-direction: column; gap: 8px;
        }
        
        #simulation-controls.active { display: flex; }
        
        #simulation-progress {
            width: 100%; height: 6px; background: #e0e0e0;
            border-radius: 3px; margin-bottom: 4px;
        }
        
        #simulation-progress-bar {
            height: 100%; background: #1E88E5; border-radius: 3px;
            width: 0%; transition: width 0.1s linear;
        }
        
        .simulation-info {
            display: flex; justify-content: space-between;
            font-size: 12px; color: #666;
        }
        
        .simulation-actions { display: flex; gap: 8px; }
        
        .simulation-actions button {
            flex: 1; padding: 8px; border: none;
            border-radius: 8px; font-size: 13px;
            font-weight: 500; cursor: pointer;
        }
        
        #btn-pause { background-color: #f5f5f5; color: #666; }
        #btn-stop { background-color: #F44336; color: white; }
        
        /* ========== BOT√ìN MI UBICACI√ìN ========== */
        #btn-mi-ubicacion {
            position: fixed; bottom: 130px; right: 15px;
            width: 45px; height: 45px; border-radius: 50%;
            border: none; background: #ffffff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 20px; cursor: pointer; z-index: 9999;
            transition: background 0.3s;
        }
        
        #btn-mi-ubicacion:hover { background: #f1f1f1; }
        
        /* ========== MODAL ANUNCIOS ========== */
        #anuncio-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            justify-content: center; align-items: center; z-index: 99999;
        }
        
        .anuncio-contenido {
            background: #fff; border-radius: 16px; padding: 20px;
            width: 90%; max-width: 300px; text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); position: relative;
        }
        
        .anuncio-contenido img {
            width: 100%; border-radius: 12px; margin-bottom: 10px;
        }
        
        .anuncio-contenido h3 {
            font-size: 16px; margin-bottom: 6px; color: #333;
        }
        
        .anuncio-contenido p {
            font-size: 14px; margin-bottom: 10px; color: #555;
        }
        
        #cerrar-anuncio {
            position: absolute; top: 6px; right: 10px;
            font-size: 18px; cursor: pointer; color: #888;
        }
        
        /* ========== MODO OSCURO ========== */
        body.dark-mode { background: #1a1a1a; }
        
        body.dark-mode #map {
            filter: brightness(0.7) contrast(1.2);
        }
        
        body.dark-mode .floating-panel,
        body.dark-mode #top-bar,
        body.dark-mode .sidebar,
        body.dark-mode #simulation-controls {
            background: rgba(30, 30, 30, 0.98) !important;
            color: #e0e0e0;
        }
        
        body.dark-mode .route-item,
        body.dark-mode .stop-item,
        body.dark-mode .step,
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #2a2a2a !important;
            color: #e0e0e0 !important;
            border-color: #444 !important;
        }
        
        body.dark-mode .panel-header,
        body.dark-mode .sidebar-header {
            background: linear-gradient(135deg, #1a4d7a 0%, #2d3561 100%) !important;
        }
        
        body.dark-mode .ia-message {
            background: #2a2a2a !important;
            color: #e0e0e0 !important;
        }
        
        body.dark-mode #weather-info,
        body.dark-mode #time-info {
            background: rgba(255, 255, 255, 0.1) !important;
            color: #e0e0e0;
        }
        
        .dark-mode-icon {
            transition: transform 0.3s ease;
        }
        
        body.dark-mode .dark-mode-icon {
            transform: rotate(180deg);
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 480px) {
            #top-bar-container { top: 5px; width: 98%; }
            .floating-tabs { bottom: 10px; gap: 8px; }
            .tab-button { width: 40px; height: 40px; font-size: 16px; }
            .floating-panel { bottom: 70px; max-height: 60vh; }
            #simulation-controls { bottom: 70px; }
        }
    </style>
</head>
<body>
    <!-- MAPA -->
    <div id="map"></div>
    
    <!-- BOT√ìN MI UBICACI√ìN -->
    <button id="btn-mi-ubicacion" onclick="centrarEnMiUbicacion()" title="Mi ubicaci√≥n">üìç</button>
    
    <!-- MODAL ANUNCIOS -->
    <div id="anuncio-modal">
        <div class="anuncio-contenido" onclick="mostrarRutaAnuncio()">
            <span id="cerrar-anuncio" onclick="cerrarAnuncio(event)">√ó</span>
            <img id="anuncio-img" src="" alt="Anuncio">
            <h3 id="anuncio-titulo"></h3>
            <p id="anuncio-desc"></p>
        </div>
    </div>
    
    <!-- BARRA SUPERIOR -->
    <div id="top-bar-container">
        <div id="top-bar">
            <div id="info-bar">
                <div id="weather-info">
                    <i class="fas fa-cloud-sun"></i>
                    <span>Cargando clima...</span>
                </div>
                <div id="time-info">
                    <i class="fas fa-clock"></i>
                    <span id="current-time"></span>
                </div>
            </div>
            
            <div id="main-controls">
                <div class="input-container">
                    <i class="fas fa-map-marker-alt"></i>
                    <input type="text" id="origin" placeholder="Origen o ubicaci√≥n actual" autocomplete="off">
                </div>
                <div class="input-container" style="display:flex; gap:8px;">
                    <div style="flex:1; position:relative;">
                        <i class="fas fa-flag" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#666;"></i>
                        <input type="text" id="destination" placeholder="Destino" autocomplete="off" style="width:100%; padding-left:40px;">
                    </div>
                    <button onclick="buscarPorVoz()" style="width:44px; height:44px; border:none; border-radius:10px; background:#4CAF50; color:white; cursor:pointer; font-size:20px; flex-shrink:0;" title="Buscar por voz">
                        üé§
                    </button>
                </div>
                
                <div id="action-buttons">
                    <button id="btn-go" onclick="planRoute()">
                        <i class="fas fa-route"></i> Ruta
                    </button>
                    <button id="btn-go" onclick="planRoute()">
                        <i class="fas fa-route"></i> Ruta
                    </button>
                    <button id="btn-clear" onclick="clearRoute()">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
        <button id="toggle-panel-btn" onclick="togglePanelVisibility()">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>
    
    <!-- TABS FLOTANTES -->
    <div class="floating-tabs">
        <button class="tab-button" id="btn-ia" onclick="togglePanel('ia-panel')" title="Asistente IA">
            <i class="fas fa-robot"></i>
        </button>
        <button class="tab-button" id="btn-routes" onclick="togglePanel('routes-panel')" title="Rutas">
            <i class="fas fa-bus"></i>
        </button>
        <button class="tab-button" id="btn-directions" onclick="togglePanel('directions-panel')" title="Instrucciones">
            <i class="fas fa-list-ol"></i>
        </button>
        <button class="tab-button" id="btn-favoritos" onclick="togglePanel('favoritos-panel')" title="Favoritos">
            <i class="fas fa-star"></i>
        </button>
        <button class="tab-button" id="btn-stats" onclick="togglePanel('stats-panel')" title="Estad√≠sticas">
            <i class="fas fa-chart-bar"></i>
        </button>
        <button class="tab-button" id="btn-add-route" onclick="togglePanel('add-route-panel')" title="Agregar ruta">
            <i class="fas fa-plus"></i>
        </button>
        <button class="tab-button" id="btn-report" onclick="togglePanel('report-panel')" title="Reportar">
            <i class="fas fa-exclamation-triangle"></i>
        </button>
        <button class="tab-button" id="btn-simulate" onclick="startSimulation()" title="Simular">
            <i class="fas fa-play"></i>
        </button>
        <button class="tab-button" id="btn-dark-mode" onclick="toggleDarkMode()" title="Modo oscuro">
            <i class="fas fa-moon dark-mode-icon"></i>
        </button>
    </div>
    
    <!-- PANEL ASISTENTE IA -->
    <div class="floating-panel" id="ia-panel">
        <div class="panel-header">
            <h3>ü§ñ Asistente de Ruta IA</h3>
            <span class="close-btn" onclick="togglePanel('ia-panel')">&times;</span>
        </div>
        <div class="panel-content">
            <div id="ia-chat">
                <div class="message ia-message">
                    ¬°Hola! Soy tu asistente inteligente. Puedo ayudarte con:<br><br>
                    üöå "¬øC√≥mo llego de CAPU al Z√≥calo?"<br>
                    üìç "¬øQu√© rutas pasan por Angel√≥polis?"<br>
                    ‚ö†Ô∏è "¬øHay retrasos en la ruta 5?"<br>
                    ‚è±Ô∏è "¬øCu√°nto tiempo tarda?"
                </div>
            </div>
            <form id="ia-form" onsubmit="sendIAChat(); return false;">
                <input type="text" id="ia-input" placeholder="Escribe tu pregunta..." required>
                <button type="submit"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
    
    <!-- PANEL RUTAS -->
    <div class="floating-panel" id="routes-panel">
        <div class="panel-header">
            <h3>üöå Rutas de Transporte</h3>
            <span class="close-btn" onclick="togglePanel('routes-panel')">&times;</span>
        </div>
        <div class="panel-content" id="routes-list"></div>
    </div>
    
    <!-- PANEL INSTRUCCIONES -->
    <div class="floating-panel" id="directions-panel">
        <div class="panel-header">
            <h3>üìã Instrucciones de Ruta</h3>
            <span class="close-btn" onclick="togglePanel('directions-panel')">&times;</span>
        </div>
        <div class="panel-content" id="directions-list"></div>
    </div>
    
    <!-- PANEL FAVORITOS -->
    <div class="floating-panel" id="favoritos-panel">
        <div class="panel-header">
            <h3>‚≠ê Rutas Favoritas</h3>
            <span class="close-btn" onclick="togglePanel('favoritos-panel')">&times;</span>
        </div>
        <div class="panel-content" id="favoritos-lista">
            <p style="text-align:center; color:#999; padding:20px;">No tienes favoritos guardados</p>
        </div>
    </div>
    
    <!-- PANEL ESTAD√çSTICAS -->
    <div class="floating-panel" id="stats-panel">
        <div class="panel-header">
            <h3>üìä Tus Estad√≠sticas</h3>
            <span class="close-btn" onclick="togglePanel('stats-panel')">&times;</span>
        </div>
        <div class="panel-content" id="stats-content">
            <p style="text-align:center; padding:20px; color:#999;">Cargando estad√≠sticas...</p>
        </div>
    </div>
    
    <!-- PANEL AGREGAR RUTA -->
    <div class="floating-panel" id="add-route-panel">
        <div class="panel-header">
            <h3>‚ûï Agregar Nueva Ruta</h3>
            <span class="close-btn" onclick="togglePanel('add-route-panel')">&times;</span>
        </div>
        <div class="panel-content">
            <form id="add-route-form" onsubmit="addNewRoute(); return false;">
                <div class="form-group">
                    <label for="route-name">Nombre de la ruta:</label>
                    <input type="text" id="route-name" placeholder="Ej: Ruta 5 - CAPU a Angel√≥polis" required>
                </div>
                <div class="form-group">
                    <label for="route-color">Color:</label>
                    <input type="color" id="route-color" value="#1E88E5" required>
                </div>
                <div class="form-group">
                    <label for="route-stops">Paradas (separadas por comas):</label>
                    <textarea id="route-stops" placeholder="Ej: CAPU, Plaza Dorada, Angel√≥polis" required></textarea>
                </div>
                <div class="form-group">
                    <label for="route-vehicle">Tipo de veh√≠culo:</label>
                    <select id="route-vehicle" required>
                        <option value="combi">Combi</option>
                        <option value="bus">Autob√∫s</option>
                        <option value="trolley">Troleb√∫s</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="togglePanel('add-route-panel')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Ruta</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- PANEL REPORTAR -->
    <div class="floating-panel" id="report-panel">
        <div class="panel-header">
            <h3>‚ö†Ô∏è Reportar Incidente</h3>
            <span class="close-btn" onclick="togglePanel('report-panel')">&times;</span>
        </div>
        <div class="panel-content">
            <form id="report-form" onsubmit="sendReport(); return false;">
                <div class="form-group">
                    <label for="report-route">Ruta afectada:</label>
                    <select id="report-route" required>
                        <option value="">Selecciona una ruta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="report-type">Tipo de incidente:</label>
                    <select id="report-type" required>
                        <option value="">Selecciona un tipo</option>
                        <option value="delay">Retraso</option>
                        <option value="accident">Accidente</option>
                        <option value="breakdown">Veh√≠culo descompuesto</option>
                        <option value="crowded">Demasiado lleno</option>
                        <option value="robo">Robo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="report-details">Detalles:</label>
                    <textarea id="report-details" placeholder="Describe el incidente..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="togglePanel('report-panel')">Cancelar</button>
                    <button type="submit" class="btn-primary">Enviar Reporte</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- CONTROLES SIMULACI√ìN -->
    <div id="simulation-controls">
        <div id="simulation-progress">
            <div id="simulation-progress-bar"></div>
        </div>
        <div class="simulation-info">
            <span id="simulation-time">0:00</span>
            <span id="simulation-distance">0 km</span>
        </div>
        <div class="simulation-actions">
            <button id="btn-pause" onclick="toggleSimulation()">
                <i class="fas fa-pause"></i> Pausar
                <button id="clear-btn" onclick="limpiarChat()" style="background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
    Limpiar Memoria
</button>

            </button>
            <button id="btn-stop" onclick="stopSimulation()">
                <i class="fas fa-stop"></i> Detener
            </button>
        </div>
    </div>
    
    <!-- SIDEBAR ALERTAS -->
    <div class="sidebar" id="alerts-sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-title">üö® Alertas Recientes</h4>
            <span class="sidebar-close" onclick="closeSidebar('alerts-sidebar')">&times;</span>
        </div>
        <div id="alerts-list"></div>
    </div>
    
    <!-- SCRIPTS -->
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
      function limpiarChat() {
    if(confirm("¬øBorrar toda la memoria de este chat?")) {
        localStorage.removeItem('chat_transit'); // Elimina solo los datos de este celular
        location.reload(); // Recarga la app para empezar de cero
    }
}

        // ========== VARIABLES GLOBALES ==========
        let map, userMarker, busMarkers = [], stopMarkers = [], routeControls = [];
        let currentRoute, currentRoutePolyline, simulationInterval, simulationPosition = 0;
        let isSimulating = false, isPaused = false, userLocationWatch;
        let busSimulations = [], routes = {}, alerts = [];
        
        const defaultLocation = [19.050839, -98.145414];
        
        // ========== PARADAS ==========
        const stops = {
            "Amalucan": [19.050839, -98.145414],
            "Z√≥calo": [19.043897, -98.198002],
            "CAPU": [19.073712, -98.204379],
            "Angel√≥polis": [19.031959, -98.232758],
            "parque ecol√≥gico": [19.029612, -98.186424],
            "Plaza Dorada": [19.028296, -98.203427],
            "Galer√≠as Serd√°n": [19.071525, -98.225347],
            "Estadio Cuauht√©moc": [19.077940, -98.164414],
            "Mercado de Sabores": [19.050987, -98.205716],
            "V√≠a Atlixc√°yotl": [19.008524, -98.265068],
            "Bosques de San Sebasti√°n": [19.066800, -98.136900],
            "Entronque Amalucan": [19.041919, -98.147035],
            "Clinica 55": [19.050272, -98.147472],
            "AV Del Roble": [19.050360, -98.145013],
            "Manuel rivera anaya": [19.056881, -98.146034],
            "Mercado amalucan": [19.053257, -98.146861],
            "Cobaep u15": [19.055726, -98.141174],
            "Encino 12": [19.053846, -98.143317],
            "D'Barruch": [19.050552, -98.150808],
            "Blvd xonacatepec": [19.050452, -98.151726],
            "El capricho": [19.054067, -98.157061],
            "Alm": [19.052362, -98.160726],
            "68A": [19.050438, -98.163795],
            "Xonaca": [19.045892, -98.178754],
            "scotiabank": [19.060875, -98.159890],
            "Paseo bravo": [19.046801, -98.207194],
            "R.chachapa36": [19.054142, -98.114619],
            "R.Santa mago35": [19.053966, -98.119829],
            "R.Mixatlac": [19.054322, -98.123780]
        };
        
        // ========== ANUNCIOS ==========
        const tiempoAnuncio = 180000;
        const negocios = [
            {
                nombre: "Tacos El G√ºero",
                descripcion: "A solo 3km de ti. ¬°Corre por tus tacos üåÆ!",
                imagen: "https://static.wixstatic.com/media/6c5d60_f9e3a3b3e0b6451a9b21a1523ebbd038~mv2.jpg",
                coordenadas: [19.0497, -98.1512]
            },
            {
                nombre: "Tacos Arandas",
                descripcion: "2x1 en pastor todos los martes üî•",
                imagen: "https://media-cdn.tripadvisor.com/media/photo-s/1b/e5/88/4b/tacos-arandas.jpg",
                coordenadas: [19.0519, -98.1537]
            }
        ];
        let negocioActual = null;
        
        function mostrarAnuncio() {
            negocioActual = negocios[Math.floor(Math.random() * negocios.length)];
            document.getElementById("anuncio-img").src = negocioActual.imagen;
            document.getElementById("anuncio-titulo").textContent = negocioActual.nombre;
            document.getElementById("anuncio-desc").textContent = negocioActual.descripcion;
            document.getElementById("anuncio-modal").style.display = "flex";
        }
        
        function cerrarAnuncio(event) {
            event.stopPropagation();
            document.getElementById("anuncio-modal").style.display = "none";
        }
        
        function mostrarRutaAnuncio() {
            document.getElementById("anuncio-modal").style.display = "none";
            if (!userMarker) {
                mostrarToast("‚ö†Ô∏è No se ha detectado tu ubicaci√≥n a√∫n");
                return;
            }
            const origen = userMarker.getLatLng();
            const destino = negocioActual.coordenadas;
            if (window.rutaControl) map.removeControl(window.rutaControl);
            window.rutaControl = L.Routing.control({
                waypoints: [L.latLng(origen.lat, origen.lng), L.latLng(destino[0], destino[1])],
                routeWhileDragging: false
            }).addTo(map);
        }
        
        setInterval(mostrarAnuncio, tiempoAnuncio);
        
        function centrarEnMiUbicacion() {
            if (!userMarker) {
                mostrarToast("‚ö†Ô∏è No se ha detectado tu ubicaci√≥n a√∫n");
                return;
            }
            const coords = userMarker.getLatLng();
            map.setView(coords, 16);
            mostrarToast("üìç Centrado en tu ubicaci√≥n");
        }
        
        // ========== INICIALIZACI√ìN DEL MAPA ==========
        function initMap() {
            map = L.map('map', {
                center: defaultLocation,
                zoom: 14,
                zoomControl: false,
                tap: false
            });
            
            L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap, CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // L√≠nea decorativa
            const linea1Coords = [
                [19.054142, -98.114619], [19.053966, -98.119829],
                [19.054322, -98.123780], [19.062520, -98.163882]
            ];
            L.polyline(linea1Coords, {
                color: 'red', weight: 5, opacity: 0.7, dashArray: '10, 5'
            }).addTo(map);
            
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            
            loadInitialRoutes();
            showStopsOnMap();
            setupGeolocation();
            updateTime();
            fetchWeather();
            setInterval(updateTime, 60000);
            setInterval(fetchWeather, 300000);
            setupEventListeners();
            
            setTimeout(() => animarAutobusesEnRutas(), 2000);
            setTimeout(habilitarNotificaciones, 3000);
            setTimeout(cargarFavoritos, 1000);
            
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                const icon = document.querySelector('.dark-mode-icon');
                if (icon) icon.className = 'fas fa-sun dark-mode-icon';
            }
        }
        
        // ========== CARGAR RUTAS INICIALES ==========
        function loadInitialRoutes() {
            routes = {
                "Ruta 1": {
                    color: "#1E88E5",
                    stops: ["Cobaep u15", "Encino 12", "D'Barruch", "Blvd xonacatepec", "El capricho", "Alm", "68A", "Xonaca"],
                    vehicle: "combi"
                },
                "Ruta 2": {
                    color: "#FF5722",
                    stops: ["R.chachapa36", "R.Santa mago35", "R.Mixatlac"],
                    vehicle: "bus"
                },
                "Ruta 3": {
                    color: "#4CAF50",
                    stops: ["parque ecol√≥gico", "Plaza Dorada"],
                    vehicle: "combi"
                }
            };
            
            showRoutesOnMap();
            updateRoutesList();
            updateReportRoutesList();
        }
        
        // ========== AUTOBUSES ANIMADOS ==========
        // NUEVA FUNCI√ìN: Los buses ahora siguen las calles del mapa
function animarAutobusesEnRutas() {
    Object.entries(routes).forEach(([nombre, ruta]) => {
        const paradasLatLng = ruta.stops.map(s => L.latLng(stops[s][0], stops[s][1]));

        // Creamos un control de ruta invisible para obtener el camino por las calles
        const router = L.Routing.control({
            waypoints: paradasLatLng,
            routeWhileDragging: false,
            addWaypoints: false,
            show: false,
            createMarker: () => null // No queremos ver marcadores extra
        }).addTo(map);

        router.on('routesfound', function(e) {
            const caminoReal = e.routes[0].coordinates; // Estas son las calles exactas
            
            const iconoBus = L.divIcon({
                className: 'bus-marker',
                html: `<div style="background:${ruta.color}; width:22px; height:22px; border-radius:50%; border:2px solid white; display:flex; align-items:center; justify-content:center; font-size:12px;">üöå</div>`,
                iconSize: [22, 22]
            });

            const busMarker = L.marker(caminoReal[0], { icon: iconoBus }).addTo(map);
            
            let paso = 0;
            // El bus avanza por cada punto del camino calculado por el GPS
            setInterval(() => {
                if (paso >= caminoReal.length) paso = 0;
                busMarker.setLatLng(caminoReal[paso]);
                paso++;
            }, 100); // Velocidad del bus siguiendo la calle
        });
    });
}

        
        // ========== MOSTRAR PARADAS ==========
        function showStopsOnMap() {
            stopMarkers.forEach(marker => map.removeLayer(marker));
            stopMarkers = [];
            
            Object.entries(stops).forEach(([name, coords]) => {
                const marker = L.circleMarker(coords, {
                    radius: 6,
                    fillColor: '#4CAF50',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                marker.bindPopup(`<b>${name}</b><br>Parada de transporte`);
                stopMarkers.push(marker);
            });
        }
        
        // ========== MOSTRAR RUTAS EN MAPA ==========
        function showRoutesOnMap() {
            routeControls.forEach(control => map.removeControl(control));
            routeControls = [];
            busSimulations.forEach(sim => {
                clearInterval(sim.interval);
                map.removeLayer(sim.marker);
            });
            busSimulations = [];
            
            Object.entries(routes).forEach(([name, route]) => {
                const waypoints = route.stops.map(stop => L.latLng(stops[stop][0], stops[stop][1]));
                
                if (waypoints.length >= 2) {
                    const control = L.Routing.control({
                        waypoints: waypoints,
                        routeWhileDragging: false,
                        lineOptions: {
                            styles: [{ color: route.color, weight: 6, opacity: 0.7 }]
                        },
                        show: false,
                        addWaypoints: false,
                        language: 'es',
                        createMarker: function() { return null; }
                    }).addTo(map);
                    
                    routeControls.push(control);
                }
            });
        }
        
        // ========== GEOLOCALIZACI√ìN ==========
        function setupGeolocation() {
            if (navigator.geolocation) {
                userLocationWatch = navigator.geolocation.watchPosition(
                    position => {
                        const userCoords = [position.coords.latitude, position.coords.longitude];
                        
                        if (!userMarker) {
                            userMarker = L.circleMarker(userCoords, {
                                radius: 8,
                                fillColor: '#1E88E5',
                                color: '#fff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(map);
                            userMarker.bindPopup('<b>Tu ubicaci√≥n</b>');
                        } else {
                            userMarker.setLatLng(userCoords);
                        }
                        
                        if (!document.getElementById('origin').value) {
                            document.getElementById('origin').value = 'Ubicaci√≥n actual';
                        }
                        
                        if (!currentRoute) {
                            map.setView(userCoords, 16);
                        }
                    },
                    error => {
                        console.error('Error obteniendo ubicaci√≥n:', error);
                        if (!userMarker) {
                            userMarker = L.circleMarker(defaultLocation, {
                                radius: 8,
                                fillColor: '#1E88E5',
                                color: '#fff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(map);
                            userMarker.bindPopup('<b>Ubicaci√≥n por defecto</b>');
                        }
                    },
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                );
            } else {
                userMarker = L.circleMarker(defaultLocation, {
                    radius: 8,
                    fillColor: '#1E88E5',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                userMarker.bindPopup('<b>Ubicaci√≥n por defecto</b>');
            }
        }
        
        // ========== PLANIFICAR RUTA ==========
        function planRoute() {
            const originInput = document.getElementById('origin').value.trim();
            const destinationInput = document.getElementById('destination').value.trim();
            
            if (!originInput || !destinationInput) {
                mostrarToast("‚ö†Ô∏è Por favor ingresa origen y destino");
                return;
            }
            
            clearRoute();
            
            Promise.all([
                getCoordinates(originInput, true),
                getCoordinates(destinationInput, false)
            ]).then(([originCoords, destinationCoords]) => {
                if (!originCoords || !destinationCoords) {
                    mostrarToast("‚ùå No se pudo encontrar una o ambas ubicaciones");
                    return;
                }
                
                currentRoute = L.Routing.control({
                    waypoints: [
                        L.latLng(originCoords[0], originCoords[1]),
                        L.latLng(destinationCoords[0], destinationCoords[1])
                    ],
                    routeWhileDragging: false,
                    lineOptions: {
                        styles: [{ color: '#1E88E5', weight: 6, opacity: 0.8 }]
                    },
                    show: false,
                    addWaypoints: false,
                    language: 'es',
                    createMarker: function() { return null; }
                }).addTo(map);
                
                currentRoute.on('routesfound', function(e) {
                    const route = e.routes[0];
                    const coords = route.coordinates;
                    
                    currentRoutePolyline = L.polyline(coords, {
                        color: '#1E88E5',
                        weight: 6,
                        opacity: 0.8
                    }).addTo(map);
                    
                    map.fitBounds(L.latLngBounds(coords), { padding: [50, 50] });
                    showDirections(route.instructions);
                    
                    const distanciaKm = (route.summary.totalDistance / 1000).toFixed(1);
                    const duracionMin = Math.round(route.summary.totalTime / 60);
                    guardarViaje(originInput, destinationInput, parseFloat(distanciaKm), duracionMin);
                    
                    const favBtn = document.createElement('button');
                    favBtn.textContent = '‚≠ê Guardar como favorito';
                    favBtn.style.cssText = 'width:100%; padding:12px; background:#FFC107; color:#333; border:none; border-radius:8px; margin-top:10px; font-weight:600; cursor:pointer;';
                    favBtn.onclick = () => guardarFavorito(originInput, destinationInput);
                    document.getElementById('directions-list').appendChild(favBtn);
                });
                
                togglePanel('directions-panel');
            });
        }
        
        // ========== OBTENER COORDENADAS ==========
        function getCoordinates(location, isOrigin) {
            return new Promise(resolve => {
                if (location === 'Ubicaci√≥n actual' && userMarker) {
                    resolve(userMarker.getLatLng());
                    return;
                }
                
                if (stops[location]) {
                    resolve(stops[location]);
                    return;
                }
                
                setTimeout(() => {
                    let foundCoords = null;
                    for (const stopName in stops) {
                        if (stopName.toLowerCase().includes(location.toLowerCase())) {
                            foundCoords = stops[stopName];
                            break;
                        }
                    }
                    resolve(foundCoords || null);
                }, 500);
            });
        }
        
        // ========== MOSTRAR INSTRUCCIONES ==========
        function showDirections(instructions) {
            const directionsList = document.getElementById('directions-list');
            directionsList.innerHTML = '';
            
            instructions.forEach((instruction, index) => {
                const step = document.createElement('div');
                step.className = 'step';
                
                const isBus = instruction.text.includes('Tome el autob√∫s') || 
                              instruction.text.includes('Tome el transporte');
                
                step.innerHTML = `
                    <div class="step-icon ${isBus ? 'bus-icon' : ''}">
                        ${isBus ? '<i class="fas fa-bus"></i>' : index + 1}
                    </div>
                    <div class="step-content">
                        <div class="step-title">${instruction.text.replace(/<\/?b>/g, '')}</div>
                        <div class="step-distance">${(instruction.distance / 1000).toFixed(1)} km</div>
                    </div>
                `;
                
                directionsList.appendChild(step);
            });
        }
        
        // ========== LIMPIAR RUTA ==========
        function clearRoute() {
            if (currentRoute) {
                map.removeControl(currentRoute);
                currentRoute = null;
            }
            if (currentRoutePolyline) {
                map.removeLayer(currentRoutePolyline);
                currentRoutePolyline = null;
            }
            document.getElementById('directions-list').innerHTML = '';
            stopSimulation();
        }
        
        // ========== SIMULACI√ìN ==========
        function startSimulation() {
            if (!currentRoute || !currentRoutePolyline) {
                mostrarToast("‚ö†Ô∏è Primero planifica una ruta");
                return;
            }
            if (isSimulating) return;
            
            isSimulating = true;
            isPaused = false;
            simulationPosition = 0;
            
            document.getElementById('simulation-controls').classList.add('active');
            
            const simulationIcon = L.divIcon({
                className: 'bus-marker pulse',
                html: '<i class="fas fa-user"></i>',
                iconSize: [20, 20]
            });
            
            const simulationMarker = L.marker(currentRoutePolyline.getLatLngs()[0], {
                icon: simulationIcon,
                zIndexOffset: 1000
            }).addTo(map);
            
            simulationMarker.bindPopup('<b>Simulando tu viaje</b>').openPopup();
            
            const totalDistance = currentRoutePolyline.getLatLngs().reduce((total, latLng, index, array) => {
                if (index > 0) {
                    return total + map.distance(array[index - 1], latLng);
                }
                return total;
            }, 0);
            
            const startTime = Date.now();
            let lastUpdate = 0;
            
            simulationInterval = setInterval(() => {
                if (isPaused) return;
                
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / 30000, 1);
                
                simulationPosition = Math.floor(progress * (currentRoutePolyline.getLatLngs().length - 1));
                const currentLatLng = currentRoutePolyline.getLatLngs()[simulationPosition];
                
                simulationMarker.setLatLng(currentLatLng);
                document.getElementById('simulation-progress-bar').style.width = `${progress * 100}%`;
                
                if (Date.now() - lastUpdate > 500) {
                    const distanceCovered = totalDistance * progress;
                    const timeElapsed = elapsed / 1000;
                    
                    document.getElementById('simulation-time').textContent = 
                        `${Math.floor(timeElapsed / 60)}:${Math.floor(timeElapsed % 60).toString().padStart(2, '0')}`;
                    
                    document.getElementById('simulation-distance').textContent = 
                        `${(distanceCovered / 1000).toFixed(1)} km`;
                    
                    lastUpdate = Date.now();
                }
                
                if (progress >= 1) {
                    stopSimulation();
                }
            }, 100);
            
            currentRoute.simulation = {
                marker: simulationMarker,
                interval: simulationInterval
            };
        }
        
        function toggleSimulation() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('btn-pause');
            
            if (isPaused) {
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> Reanudar';
            } else {
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pausar';
            }
        }
        
        function stopSimulation() {
            if (!isSimulating) return;
            
            clearInterval(simulationInterval);
            
            if (currentRoute && currentRoute.simulation) {
                map.removeLayer(currentRoute.simulation.marker);
                clearInterval(currentRoute.simulation.interval);
            }
            
            isSimulating = false;
            isPaused = false;
            
            document.getElementById('simulation-controls').classList.remove('active');
            document.getElementById('simulation-progress-bar').style.width = '0%';
        }
        
        // ========== ACTUALIZAR LISTAS ==========
        function updateRoutesList() {
            const routesList = document.getElementById('routes-list');
            routesList.innerHTML = '';
            
            Object.entries(routes).forEach(([name, route]) => {
                const routeItem = document.createElement('div');
                routeItem.className = 'route-item';
                routeItem.onclick = () => showRouteDetails(name);
                
                routeItem.innerHTML = `
                    <div class="route-color" style="background-color: ${route.color}"></div>
                    <div class="route-info">
                        <div class="route-name">${name}</div>
                        <div class="route-stops">${route.stops.join(' ‚Üí ')}</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #999;"></i>
                `;
                
                routesList.appendChild(routeItem);
            });
        }
        
        function showRouteDetails(routeName) {
            const route = routes[routeName];
            const bounds = L.latLngBounds(route.stops.map(stop => stops[stop]));
            map.fitBounds(bounds, { padding: [50, 50] });
            
            document.getElementById('ia-chat').innerHTML += `
                <div class="message ia-message">
                    <b>${routeName}</b><br>
                    Paradas: ${route.stops.join(' ‚Üí ')}<br>
                    Tipo: ${route.vehicle === 'bus' ? 'Autob√∫s' : 'Combi'}
                </div>
            `;
            document.getElementById('ia-chat').scrollTop = document.getElementById('ia-chat').scrollHeight;
            togglePanel('ia-panel');
        }
        
        function updateReportRoutesList() {
            const reportRouteSelect = document.getElementById('report-route');
            reportRouteSelect.innerHTML = '<option value="">Selecciona una ruta</option>';
            
            Object.keys(routes).forEach(routeName => {
                const option = document.createElement('option');
                option.value = routeName;
                option.textContent = routeName;
                reportRouteSelect.appendChild(option);
            });
        }
        
        // ========== REPORTES ==========
        function sendReport() {
            const route = document.getElementById('report-route').value;
            const type = document.getElementById('report-type').value;
            const details = document.getElementById('report-details').value;
            
            if (!route || !type || !details) {
                mostrarToast("‚ö†Ô∏è Por favor completa todos los campos");
                return;
            }
            
            const alert = {
                id: Date.now(),
                route,
                type,
                details,
                timestamp: new Date(),
                location: stops[routes[route].stops[0]]
            };
            
            alerts.unshift(alert);
            updateAlertsList();
            showAlertOnMap(alert);
            
            document.getElementById('report-form').reset();
            togglePanel('report-panel');
            
            mostrarToast("‚úÖ Reporte enviado correctamente");
        }
        
        function getAlertTypeText(type) {
            const types = {
                'delay': 'Retraso',
                'accident': 'Accidente',
                'breakdown': 'Veh√≠culo descompuesto',
                'crowded': 'Demasiado lleno',
                'robo': 'Robo'
            };
            return types[type] || type;
        }
        
        function showAlertOnMap(alert) {
            const alertIcon = L.divIcon({
                className: 'alert-marker pulse',
                html: '!',
                iconSize: [20, 20]
            });
            
            const alertMarker = L.marker(alert.location, {
                icon: alertIcon,
                zIndexOffset: 1000
            }).addTo(map);
            
            alertMarker.bindPopup(`
                <b>Alerta en ${alert.route}</b><br>
                Tipo: ${getAlertTypeText(alert.type)}<br>
                ${alert.details}<br>
                <small>${formatTime(alert.timestamp)}</small>
            `).openPopup();
            
            alert.marker = alertMarker;
        }
        
        function updateAlertsList() {
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = '';
            
            alerts.slice(0, 10).forEach(alert => {
                const alertItem = document.createElement('div');
                alertItem.className = 'alert-item';
                alertItem.onclick = () => {
                    map.setView(alert.location, 16);
                    if (alert.marker) {
                        alert.marker.openPopup();
                    }
                    closeSidebar('alerts-sidebar');
                };
                
                alertItem.innerHTML = `
                    <div class="alert-title">${getAlertTypeText(alert.type)} en ${alert.route}</div>
                    <div class="alert-details">${alert.details}</div>
                    <div class="alert-time">${formatTime(alert.timestamp)}</div>
                `;
                
                alertsList.appendChild(alertItem);
            });
        }
        
        // ========== AGREGAR RUTA ==========
        function addNewRoute() {
            const name = document.getElementById('route-name').value.trim();
            const color = document.getElementById('route-color').value;
            const stopsInput = document.getElementById('route-stops').value.trim();
            const vehicle = document.getElementById('route-vehicle').value;
            
            if (!name || !stopsInput) {
                mostrarToast("‚ö†Ô∏è Por favor completa todos los campos");
                return;
            }
            
            const stopNames = stopsInput.split(',').map(s => s.trim()).filter(s => s);
            const unknownStops = stopNames.filter(stop => !stops[stop]);
            
            if (unknownStops.length > 0) {
                mostrarToast(`‚ùå Las siguientes paradas no existen: ${unknownStops.join(', ')}`);
                return;
            }
            
            routes[name] = {
                color,
                stops: stopNames,
                vehicle
            };
            
            showRoutesOnMap();
            updateRoutesList();
            updateReportRoutesList();
            
            document.getElementById('add-route-form').reset();
            togglePanel('add-route-panel');
            
            mostrarToast(`‚úÖ Ruta "${name}" agregada exitosamente`);
        }
        
        // ========== ASISTENTE IA ==========
        async function sendIAChat() {
    const input = document.getElementById('ia-input');
    const chat = document.getElementById('ia-chat');
    const texto = input.value.trim();

    if (!texto) return;

    // Mostrar mensaje del usuario
    chat.innerHTML += `<div class="message user-message">${texto}</div>`;
    input.value = '';

    // Mostrar burbuja de espera
    const idTemp = "temp-" + Date.now();
    chat.innerHTML += `<div id="${idTemp}" class="message ia-message">Buscando ruta...</div>`;
    chat.scrollTop = chat.scrollHeight;

    // LLAMADA A LA NUEVA IA (GROQ)
    const respuestaIA = await generateIAResponse(texto);

    // Reemplazar espera por respuesta real
    document.getElementById(idTemp).innerText = respuestaIA;
    chat.scrollTop = chat.scrollHeight;
}

        
 async function generateIAResponse(mensajeUsuario) {
    const API_KEY = "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"; 

    // Carga la memoria espec√≠fica de ESTE celular o crea una nueva si est√° vac√≠a
    let memoriaLocal = JSON.parse(localStorage.getItem('chat_transit')) || [
        { "role": "system", "content": "Eres TransitMaster, experto en rutas de Puebla como Amalucan y el Estadio. Tienes memoria de la conversaci√≥n actual." }
    ];

    // Guarda lo que el usuario acaba de escribir en su memoria local
    memoriaLocal.push({ "role": "user", "content": mensajeUsuario });

    const respuesta = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            "model": "llama-3.3-70b-versatile",
            "messages": memoriaLocal // Env√≠a el historial completo de este usuario
        })
    });

    const data = await respuesta.json();
    const textoIA = data.choices[0].message.content;

    // Guarda la respuesta de la IA para que no la olvide en el siguiente mensaje
    memoriaLocal.push({ "role": "assistant", "content": textoIA });
    localStorage.setItem('chat_transit', JSON.stringify(memoriaLocal));

    return textoIA;
}

        
        // ========== FAVORITOS ==========
        function guardarFavorito(origen, destino) {
            let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]');
            
            const existe = favoritos.some(f => f.origen === origen && f.destino === destino);
            if (existe) {
                mostrarToast('‚ö†Ô∏è Esta ruta ya est√° en favoritos');
                return;
            }
            
            favoritos.push({
                origen,
                destino,
                fecha: Date.now()
            });
            
            localStorage.setItem('favoritos', JSON.stringify(favoritos));
            cargarFavoritos();
            mostrarToast('‚≠ê Ruta guardada en favoritos');
        }
        
        function cargarFavoritos() {
            const favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]');
            const lista = document.getElementById('favoritos-lista');
            
            if (favoritos.length === 0) {
                lista.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No tienes favoritos guardados</p>';
                return;
            }
            
            lista.innerHTML = favoritos.map((fav, index) => `
                <div class="route-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <div onclick="usarFavorito('${fav.origen}', '${fav.destino}')" style="flex:1; cursor:pointer;">
                        <div style="font-weight:600; margin-bottom:4px;">üìç ${fav.origen}</div>
                        <div style="font-size:13px; color:#666;">üèÅ ${fav.destino}</div>
                    </div>
                    <button onclick="eliminarFavorito(${index})" style="background:#f44336; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }
        
        function usarFavorito(origen, destino) {
            document.getElementById('origin').value = origen;
            document.getElementById('destination').value = destino;
            togglePanel('favoritos-panel');
            planRoute();
        }
        
        function eliminarFavorito(index) {
            let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]');
            favoritos.splice(index, 1);
            localStorage.setItem('favoritos', JSON.stringify(favoritos));
            cargarFavoritos();
            mostrarToast('üóëÔ∏è Favorito eliminado');
        }
        
        // ========== ESTAD√çSTICAS ==========
        function guardarViaje(origen, destino, distanciaKm, duracionMin) {
            const historial = JSON.parse(localStorage.getItem('historial') || '[]');
            historial.unshift({
                origen,
                destino,
                distancia: distanciaKm,
                duracion: duracionMin,
                fecha: new Date().toISOString(),
                costo: calcularTarifa(distanciaKm)
            });
            localStorage.setItem('historial', JSON.stringify(historial.slice(0, 50)));
        }
        
        function calcularTarifa(distanciaKm) {
            const tarifaBase = 10;
            const costoPorKm = 2.5;
            return (tarifaBase + (distanciaKm * costoPorKm)).toFixed(2);
        }
        
        function mostrarEstadisticas() {
            const historial = JSON.parse(localStorage.getItem('historial') || '[]');
            const contenido = document.getElementById('stats-content');
            
            if (historial.length === 0) {
                contenido.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">A√∫n no has realizado viajes</p>';
                return;
            }
            
            const totalViajes = historial.length;
            const kmTotales = historial.reduce((sum, v) => sum + (v.distancia || 0), 0);
            const costoTotal = historial.reduce((sum, v) => sum + parseFloat(v.costo || 0), 0);
            const ahorroVsUber = (kmTotales * 15).toFixed(2);
            
            contenido.innerHTML = `
                <div style="background:#f5f5f5; padding:15px; border-radius:12px; margin-bottom:15px;">
                    <div style="font-size:32px; font-weight:bold; color:#1E88E5; text-align:center;">${totalViajes}</div>
                    <div style="text-align:center; color:#666; font-size:14px;">Viajes realizados</div>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div style="background:#4CAF50; color:white; padding:12px; border-radius:10px; text-align:center;">
                        <div style="font-size:20px; font-weight:bold;">${kmTotales.toFixed(1)} km</div>
                        <div style="font-size:12px; opacity:0.9;">Distancia total</div>
                    </div>
                    <div style="background:#FF9800; color:white; padding:12px; border-radius:10px; text-align:center;">
                        <div style="font-size:20px; font-weight:bold;">$${costoTotal.toFixed(2)}</div>
                        <div style="font-size:12px; opacity:0.9;">Gastado</div>
                    </div>
                </div>
                
                <div style="background:#FFC107; padding:15px; border-radius:12px; text-align:center;">
                    <div style="font-size:18px; font-weight:600; color:#333;">üí∞ Ahorro vs Uber</div>
                    <div style="font-size:28px; font-weight:bold; color:#388E3C; margin-top:5px;">$${ahorroVsUber}</div>
                </div>
                
                <div style="margin-top:20px;">
                    <h4 style="margin-bottom:10px;">üìú √öltimos viajes</h4>
                    ${historial.slice(0, 5).map(v => `
                        <div style="background:#f5f5f5; padding:10px; border-radius:8px; margin-bottom:8px; font-size:13px;">
                            <div style="font-weight:600;">üìç ${v.origen} ‚Üí ${v.destino}</div>
                            <div style="color:#666; margin-top:4px;">
                                ${v.distancia ? v.distancia.toFixed(1) + ' km' : ''} ‚Ä¢ $${v.costo}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // ========== NOTIFICACIONES ==========
        function habilitarNotificaciones() {
            if (!("Notification" in window)) return;
            
            if (Notification.permission === "default") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("¬°Bienvenido a TransitMaster! üöå", {
                            body: "Recibir√°s alertas de tus rutas favoritas",
                            icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='75' font-size='75'%3Eüöå%3C/text%3E%3C/svg%3E",
                            vibrate: [200, 100, 200]
                        });
                    }
                });
            }
        }
        
        function notificarBusCercano(nombreRuta, minutos) {
            if (Notification.permission === "granted") {
                new Notification(`üöå ¬°Bus llegando!`, {
                    body: `La ${nombreRuta} llegar√° en ${minutos} minutos`,
                    icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='75' font-size='75'%3Eüöå%3C/text%3E%3C/svg%3E",
                    vibrate: [200, 100, 200, 100, 200],
                    requireInteraction: true
                });
            }
        }
        
        // ========== B√öSQUEDA POR VOZ ==========
        function buscarPorVoz() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                mostrarToast('‚ùå Tu navegador no soporta b√∫squeda por voz. Usa Chrome o Edge.');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'es-MX';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            mostrarToast('üé§ Escuchando...');
            
            recognition.onresult = (event) => {
                const texto = event.results[0][0].transcript;
                document.getElementById('destination').value = texto;
                mostrarToast(`‚úÖ Buscando: "${texto}"`);
            };
            
            recognition.onerror = () => {
                mostrarToast('‚ùå No se pudo reconocer la voz');
            };
            
            recognition.start();
        }
        
        // ========== MODO OSCURO ==========
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            const icon = document.querySelector('.dark-mode-icon');
            icon.className = isDark ? 'fas fa-sun dark-mode-icon' : 'fas fa-moon dark-mode-icon';
            
            mostrarToast(isDark ? 'üåô Modo oscuro activado' : '‚òÄÔ∏è Modo claro activado');
        }
        
        // ========== UTILIDADES ==========
        function mostrarToast(mensaje) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:12px 24px; border-radius:50px; z-index:9999; animation:slideUp 0.3s ease;';
            toast.textContent = mensaje;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }
        
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-MX', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('current-time').textContent = timeString;
        }
        
        function fetchWeather() {
            const weatherConditions = ['Despejado', 'Parcialmente nublado', 'Nublado', 'Lluvia ligera'];
            const randomWeather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
            const randomTemp = Math.floor(Math.random() * 10) + 20;
            
            document.getElementById('weather-info').innerHTML = `
                <i class="fas fa-${randomWeather.includes('Lluvia') ? 'cloud-rain' : 
                                   randomWeather.includes('Nublado') ? 'cloud' : 
                                   randomWeather.includes('Parcialmente') ? 'cloud-sun' : 'sun'}"></i>
                <span>${randomWeather}, ${randomTemp}¬∞C</span>
            `;
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('es-MX', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }
        
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const isActive = panel.classList.contains('active');
            
            document.querySelectorAll('.floating-panel').forEach(p => {
                p.classList.remove('active');
            });
            
            if (!isActive) {
                panel.classList.add('active');
                
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const btnMap = {
                    'ia-panel': 'btn-ia',
                    'routes-panel': 'btn-routes',
                    'directions-panel': 'btn-directions',
                    'add-route-panel': 'btn-add-route',
                    'report-panel': 'btn-report',
                    'favoritos-panel': 'btn-favoritos',
                    'stats-panel': 'btn-stats'
                };
                
                if (btnMap[panelId]) {
                    document.getElementById(btnMap[panelId]).classList.add('active');
                }
                
                if (panelId === 'stats-panel') {
                    setTimeout(mostrarEstadisticas, 100);
                }
            }
        }
        
        function togglePanelVisibility() {
            const container = document.getElementById('top-bar-container');
            container.classList.toggle('collapsed');
            
            const icon = document.querySelector('#toggle-panel-btn i');
            if (container.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }
        function closeSidebar(sidebarId) {
            document.getElementById(sidebarId).classList.remove('active');
        }
        
        function setupEventListeners() {
            document.getElementById('origin').addEventListener('input', function() {
                if (this.value.length > 2) {
                    console.log('Buscando sugerencias para:', this.value);
                }
            });
            
            document.getElementById('destination').addEventListener('input', function() {
                if (this.value.length > 2) {
                    console.log('Buscando sugerencias para:', this.value);
                }
            });
            
            map.on('click', function(e) {
                console.log('Clic en:', e.latlng);
            });
        }
        
        // ========== INICIAR APLICACI√ìN ==========
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>